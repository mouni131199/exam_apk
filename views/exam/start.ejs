<%- include('../partials/header') %>

<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2><%= exam.title %></h2>
      <% if (exam.description) { %>
        <p class="text-muted"><%= exam.description %></p>
      <% } %>
    </div>
    <div>
      <h5 class="text-danger" id="timer"></h5>
    </div>
  </div>

  <!-- ✅ Flash Message Display -->
  <% if (error && error.length > 0) { %>
    <div class="alert alert-danger">
      <% error.forEach(function(msg) { %>
        <div><%= msg %></div>
      <% }); %>
    </div>
  <% } %>

  <% if (success && success.length > 0) { %>
    <div class="alert alert-success">
      <% success.forEach(function(msg) { %>
        <div><%= msg %></div>
      <% }); %>
    </div>
  <% } %>

  <form id="examForm" action="/exam/submit/<%= exam._id %>" method="POST">
    <% questions.forEach((q, index) => { %>
      <div class="card mb-4">
        <div class="card-body">
          <h5>Q<%= index + 1 %>: <%= q.questionText %></h5>
          <% if (q.explanation && q.explanation.trim() !== "") { %>
            <p class="text-muted"><em><%= q.explanation %></em></p>
          <% } %>

          <% q.options.forEach((opt, i) => { %>
            <div class="form-check">
              <input
                class="form-check-input"
                type="<%= q.allowMultiple ? 'checkbox' : 'radio' %>"
                name="q_<%= q._id %><%= q.allowMultiple ? '[]' : '' %>"
                value="<%= i %>"
                id="q_<%= q._id %>_<%= i %>"
              >
              <label class="form-check-label" for="q_<%= q._id %>_<%= i %>">
                <%= opt %>
              </label>
            </div>
          <% }) %>
        </div>
      </div>
    <% }) %>

    <button type="submit" class="btn btn-success">Submit</button>
  </form>
</div>

<!-- ✅ Move the script above footer to ensure it's not cut off -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const examDurationMinutes = 15;
    let timeLeft = examDurationMinutes * 60;
    const timerElement = document.getElementById("timer");

    const timerInterval = setInterval(() => {
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        alert("⏰ Time's up! Submitting your exam...");
        document.getElementById("examForm").submit();
      } else {
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        timerElement.innerText = `${mins}m ${secs < 10 ? '0' : ''}${secs}s`;
        timeLeft--;
      }
    }, 1000);

    let tabSwitchCount = 0;
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        tabSwitchCount++;
        if (tabSwitchCount === 1) {
          alert("⚠️ Warning: Switching tabs is not allowed. One more attempt will auto-submit your exam.");
        } else if (tabSwitchCount >= 2) {
          alert("🚨 You switched tabs again. Submitting your exam.");
          document.getElementById("examForm").submit();
        }
      }
    });

    document.addEventListener("contextmenu", (e) => e.preventDefault());
    document.addEventListener("copy", (e) => e.preventDefault());
    document.addEventListener("cut", (e) => e.preventDefault());
    document.addEventListener("paste", (e) => e.preventDefault());

    const form = document.getElementById("examForm");
    form.addEventListener("submit", function (e) {
      const total = <%= questions.length %>;
      let answered = 0;

      <% questions.forEach((q) => { %>
        {
          const inputs = document.querySelectorAll('input[name="q_<%= q._id %><%= q.allowMultiple ? '[]' : '' %>"]');
          let checked = false;
          inputs.forEach(input => {
            if (input.checked) checked = true;
          });
          if (checked) answered++;
        }
      <% }) %>

      if (answered < total) {
        const confirmSubmit = confirm(`You answered ${answered} out of ${total} questions.\nAre you sure you want to submit?`);
        if (!confirmSubmit) e.preventDefault();
      }
    });
  });
</script>

<%- include('../partials/footer') %>
